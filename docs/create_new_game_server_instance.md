# Creating a New Game Server Instance

This document explains how to create a new game server instance using KGSM. If you haven't already, please read [Blueprints 101](blueprints.md) and [Instances 101](instances.md) for foundational knowledge.

---

## Quick Overview

There are three ways to create a new game server instance:

1. **Named Arguments**: Use the `--create` command.
2. **Interactive Mode**: Run `kgsm.sh` and select **Install** from the interactive menu.
3. **Manual Instance Creation**: Execute each module manually for full control.

---

## Option 1: Named Arguments

This is the simplest way to create an instance:

```sh
./kgsm.sh --create <blueprint> [--install-dir <directory>] [--name <name>]
```

### Arguments

- **`<blueprint>`**: The name of a blueprint file (without the `.bp` extension) located in `blueprints/custom` or `blueprints/default`.
- **`<directory>`** *(optional)*: Absolute path where the instance will be installed. If omitted, the default directory from `default_install_directory` in `config.ini` is used.
- **`<name>`** *(optional)*: Custom name for the instance. If left empty, KGSM will generate a randomized unique identifier.

> [!NOTE]
> The older `--install` parameter is still supported for backward compatibility as an alias for `--create` but is deprecated and will be removed in a future version.

### Example

```sh
./kgsm.sh --create factorio --install-dir /opt/servers --name factorio-space-age
```

---

## Option 2: Interactive Mode

Run KGSM without arguments to enter interactive mode:

```sh
./kgsm.sh
```

From the menu, choose the `Install` option. You’ll be prompted to:

- Select a blueprint.
- Provide an installation directory (if `default_install_directory` is not set in `config.ini`).
- Provide a version to download (leave empty for "latest")
- Provide an instance identifier (leave empty for "autogenerated")

---

## Option 3: Manual Instance Creation

For advanced users, each step can be executed manually. All modules are completely standalone and automatically determine the KGSM installation path and load the configuration file without requiring any manual setup.

### Step-by-Step Breakdown

Here's how the command `./kgsm.sh --create factorio --install-dir /opt/test` translates into individual steps:

### 1. Choose a Blueprint File

Select a blueprint from `blueprints/default` or `blueprints/custom`.
The blueprint selection priority is as follows:
  1. Custom native
  2. Custom container
  3. Default native
  4. Default container

Custom blueprints are prioritized over default ones, and native blueprints are prioritized over container ones.

---

### 2. Generate Instance Configuration

Run:

```sh
instance_config=$(./modules/instances.sh --create factorio --install-dir /opt/test --name my-factorio-server)
```

This generates a configuration file for the new instance. The `--name` parameter is optional - if not provided, KGSM will generate a unique identifier for the instance.

---

### 3. Create Directory Structure

Run:

```sh
./modules/directories.sh -i "$instance_config" --create
```

This sets up the required directory structure.

---

### 4. Generate Required Files

Run:

```sh
./modules/files.sh -i "$instance_config" --create
```

This generates the `<instance-name>.manage.sh` file to manage the service. If applicable:

- Overrides are copied to the install directory.
- Systemd files (`<instance-name>.service`, `<instance-name>.socket`) are created if `enable_systemd` is enabled.
- UFW firewall rules are created if `enable_firewall_management` is enabled.

> ⚠️ **Note**: Root permissions are required for `enable_systemd` or `enable_firewall_management` integrations. KGSM will prompt for password when it is needed during the process.

---

### 5. Locate the Instance Management File

After generating the instance and files, the instance is now fully standalone and doesn't need KGSM to operate. Locate the instance management file in the installation directory:

```sh
# The file will be named <instance-name>.manage.sh in the installation directory
manage_file="/opt/test/my-factorio-server.manage.sh"
```

From this point forward, you'll use this management script directly for all operations.

---

### 6. Fetch Latest Version (Optional)

If you want to install the latest version:

```sh
version=$("$manage_file" --version --latest)
```

Skip this step if you want to install a specific version.

---

### 7. Download Files

Run:

```sh
"$manage_file" --download "$version"
```

This downloads and prepares the server files.

---

### 8. Deploy Files

Run:

```sh
"$manage_file" --deploy
```

This moves files to the installation directory. If the directory isn't empty, you'll be prompted to confirm.

---

### 9. Save the Version

Run:

```sh
"$manage_file" --version --save "$version"
```

This saves the version number for future reference.

---

### 10. Done!

Your game server instance is now ready. To learn how to start, stop, and manage your new instance, see [Managing Game Servers](managing_game_servers.md).

---

## Best Practices

- **Use Defaults Where Possible**: Setting `default_install_directory` in `config.ini` simplifies the process.
- **Test Each Step**: If creating instances manually, test commands for errors.
- **Use `--help`**: All modules support the `--help` flag to list available arguments and their descriptions.
- **Read Related Documentation**: See [Instances 101](instances.md) for information about instance structure and [Managing Game Servers](managing_game_servers.md) for day-to-day operations.

---

## Troubleshooting

### Common Issues

| **Issue**                                 | **Resolution**                                     |
| ----------------------------------------- | -------------------------------------------------- |
| `KGSM_ROOT` not defined                   | Export `KGSM_ROOT` with the path to `kgsm.sh`.     |
| Missing installation directory            | Set `default_install_directory` or provide one. |
| Permission errors with `systemd` or `ufw` | Run the script with `sudo`.                        |

### Debugging

Use the `--debug` flag for detailed logs:

```sh
./kgsm.sh --create <blueprint> --debug
```

### Advanced Integration

For monitoring server creation and lifecycle events programmatically, see [KGSM Event System](events.md) documentation.
