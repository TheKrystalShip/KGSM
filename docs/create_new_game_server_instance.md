# Creating a New Game Server Instance

This document explains how to create a new game server instance using KGSM. If you haven't already, please read [Blueprints 101](blueprints.md) and [Instances 101](instances.md) for foundational knowledge.

---

## Quick Overview

There are three ways to create a new game server instance:

1. **Named Arguments**: Use the `--install` command.
2. **Interactive Mode**: Run `kgsm.sh` and select **Install** from the interactive menu.
3. **Manual Instance Creation**: Execute each module manually for full control.

---

## Option 1: Named Arguments

This is the simplest way to create an instance:

```sh
./kgsm.sh --install <blueprint> [--install-dir <directory>] [--id <id>]
```

### Arguments

- **`<blueprint>`**: The name of a blueprint file (without the `.bp` extension) located in `blueprints` or `blueprints/default`.
- **`<directory>`** *(optional)*: Absolute path where the instance will be installed. If omitted, the default directory from `INSTANCE_DEFAULT_INSTALL_DIR` in `config.ini` is used.
- **`<id>`** *(optional)*: Custom name for the instance. If left empty, KGSM will generated a randomized unique identifier.

### Example

```sh
./kgsm.sh --install factorio --install-dir /opt/servers --id factorio-space-age
```

---

## Option 2: Interactive Mode

Run KGSM without arguments to enter interactive mode:

```sh
./kgsm.sh
```

From the menu, choose the `Install` option. You’ll be prompted to:

- Select a blueprint.
- Provide an installation directory (if `INSTANCE_DEFAULT_INSTALL_DIR` is not set in `config.ini`).
- Provide a version to download (leave empty for "latest")
- Provide an instance identifier (leave empty for "autogenerated")

---

## Option 3: Manual Instance Creation

For advanced users, each step can be executed manually. Ensure the `KGSM_ROOT` variable is set to the directory containing `kgsm.sh`. Modules also require `config.ini` to be loaded; they will load it automatically if not already loaded.

### Step-by-Step Breakdown

Here’s how the command `./kgsm.sh --install factorio --install-dir /opt/test` translates into individual steps:

### 1. Choose a Blueprint File

Select a blueprint from `blueprints/default` or `blueprints`. The `.bp` extension is optional.

---

### 2. Generate Instance Configuration

Run:

```sh
instance_config=$(./modules/instances.sh --create factorio --install-dir /opt/test)
```

This generates a configuration file for the new instance.

---

### 3. Create Directory Structure

Run:

```sh
./modules/directories.sh -i $instance_config --create
```

This sets up the required directory structure.

---

### 4. Generate Required Files

Run:

```sh
./modules/files.sh -i $instance_config --create
```

This generates the `<instance>.manage.sh` file to manage the service. If applicable:

- Overrides are copied to the install directory.
- Systemd files (`<instance>.service`, `<instance>.socket`) are created if `USE_SYSTEMD` is enabled.
- UFW firewall rules are created if `USE_UFW` is enabled.

> ⚠️ **Note**: Root permissions are required for `USE_SYSTEMD` or `USE_UFW` integrations.

---

### 5. Fetch Latest Version

Run:

```sh
latest_version=$(./modules/version.sh -i $instance_config --latest)
```

This determines the latest version available.

---

### 6. Download Files

Run:

```sh
./modules/download.sh -i $instance_config
```

This downloads and prepares files in `INSTANCE_TEMP_DIR`.

---

### 7. Deploy Files

Run:

```sh
./modules/deploy.sh -i $instance_config
```

This moves files to `INSTANCE_INSTALL_DIR`. If the directory isn’t empty, you’ll be prompted to confirm.

---

### 8. Save the Version

Run:

```sh
./modules/version.sh -i $instance_config --save $latest_version
```

This saves the version number for future reference.

---

### 9. Done!

Your game server instance is now ready.

---

## Best Practices

- **Use Defaults Where Possible**: Setting `INSTANCE_DEFAULT_INSTALL_DIR` in `config.ini` simplifies the process.
- **Test Each Step**: If creating instances manually, test commands for errors.
- \*\*Use `--help`\*\*: All modules support the `--help` flag to list available arguments and their descriptions.

---

## Troubleshooting

### Common Issues

| **Issue**                                 | **Resolution**                                     |
| ----------------------------------------- | -------------------------------------------------- |
| `KGSM_ROOT` not defined                   | Export `KGSM_ROOT` with the path to `kgsm.sh`.     |
| Missing installation directory            | Set `INSTANCE_DEFAULT_INSTALL_DIR` or provide one. |
| Permission errors with `systemd` or `ufw` | Run the script with `sudo`.                        |

### Debugging

Use the `--`debug flag for detailed logs:

```sh
./kgsm.sh --install <blueprint> --debug
```

